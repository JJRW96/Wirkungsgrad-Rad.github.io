library(shiny)
library(plotly)
library(dplyr)
library(broom)
library(RColorBrewer)
library(DT)

# Spalten umbenennen
names(Bedingungen_data)[names(Bedingungen_data) == "W*Aerob [kJ]"] <- "W_Aerob"
names(Bedingungen_data)[names(Bedingungen_data) == "WPCR [kJ]"] <- "W_PCR"
names(Bedingungen_data)[names(Bedingungen_data) == "WBLC [kJ]"] <- "W_BLC"
names(Bedingungen_data)[names(Bedingungen_data) == "WTOT [kJ]"] <- "W_TOT"
names(Bedingungen_data)[names(Bedingungen_data) == "Efficiency"] <- "Torque_Efficiency"

Bedingungen_data$P_mech_kg <- Bedingungen_data$P_mech / Bedingungen_data$Masse
Bedingungen_data$VO2_net_SS_kg <- Bedingungen_data$VO2_net_SS / Bedingungen_data$Masse
Bedingungen_data$VO2_avg_kg <- Bedingungen_data$VO2_avg/ Bedingungen_data$Masse
Bedingungen_data$VO2_max <- Bedingungen_data$VO2_kg_max * Bedingungen_data$Masse

# Auswahl der gewünschten Variablen
Bedingungen_data_Shiny_Regression_vars <- c("Proband", "Nr", "Bedingung", "Intensität", 
                                             "Torque_Efficiency", "Pedal_Smoothness", 
                                             "Wirk_Brutto", "Wirk_Netto", "Wirk_Total", "Wirk_Muskulär",
                                             "Masse", "P_mech", "P_mech_kg", "nD", "VO2_kg_max", "HR_percent", "VO2_percent", 
                                             "VO2_avg", "VO2_avg_kg", "VO2_net_SS","VO2_net_SS_kg", "W_Aerob", "W_PCR", "W_TOT", "W_BLC")

# Erstellen des Datensatzes für Shiny-Regression
Bedingungen_data_Shiny_Regression <- Bedingungen_data[, Bedingungen_data_Shiny_Regression_vars]

Bedingungen_data_Shiny_Regression <- data.frame(
  `Proband` = c( "01", "01", "01", "01", "01", "01", "06", "06", "06", "06", "06", "06", "10", "10", "10", "10", "10", "10", "13", "13", "13", "13", "13", "13", "15", "15", "15", "15", "15", "15", "19", "19", "19", "19", "19", "19", "20", "20", "20", "20", "20", "20", "22", "22", "22", "22", "22", "22", "23", "23", "23", "23", "23", "23" ),
  `Nr` = c( 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6 ),
  `Bedingung` = c( "stehen", "sitzen", "sitzen", "stehen", "sitzen", "stehen", "stehen", "sitzen", "stehen", "sitzen", "stehen", "sitzen", "stehen", "sitzen", "sitzen", "stehen", "stehen", "sitzen", "stehen", "sitzen", "stehen", "sitzen", "sitzen", "stehen", "sitzen", "stehen", "sitzen", "stehen", "stehen", "sitzen", "stehen", "sitzen", "sitzen", "stehen", "sitzen", "stehen", "sitzen", "stehen", "stehen", "sitzen", "stehen", "sitzen", "sitzen", "stehen", "stehen", "sitzen", "sitzen", "stehen", "stehen", "sitzen", "sitzen", "stehen", "stehen", "sitzen" ),
  `Intensität` = c( "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer" ),
  `Torque_Efficiency` = c( 66.42, 80.67, 85.6, 72.95, 87.65, 78.67, 80.04, 86.41, 86.78, 88.63, 88.24, 92.41, 73.99, 73.77, 81.11, 85.39, 91.79, 84.47, 72.05, 72.34, 79.17, 76.95, 79.78, 85.17, 66.52, 69.93, 72.41, 82.58, 87.01, 79.53, 65.43, 72.54, 77.02, 70.47, 80.77, 78.76, 64.47, 62.05, 68.4, 71.35, 77.44, 75.1, 81.99, 82.22, 91.47, 89.76, 92.56, 97.11, 50.58, 59.59, 65.12, 56.31, 63.19, 72.06 ),
  `Pedal_Smoothness` = c( 39.710181579574, 50.8184514296743, 52.4428359792181, 40.2055948041026, 53.6791852731242, 41.0448765909455, 47.914882163269, 51.5335837768147, 49.217483982331, 51.1389458112447, 48.0336788998195, 52.8223258874823, 47.9302436519206, 51.9475600881879, 54.0606647605687, 50.6559277814877, 52.6335181401208, 54.2725782631366, 43.083675000186, 49.0637500123524, 44.6632810590617, 50.293760020264, 51.2896166830574, 46.4638901013413, 48.3291073423363, 44.2590599394396, 52.6720469537052, 47.4439436135393, 48.2471522363413, 57.9737846304978, 42.4301080469913, 50.2908406548503, 52.3570034648903, 42.7127745966365, 52.2685711057555, 44.7936090146139, 46.3565980135841, 38.3575726240913, 39.6615373251182, 49.3105354600425, 42.1880618813037, 51.4796995926358, 54.4350155934243, 49.538139286023, 51.844375965857, 57.5052389013286, 57.6775357922151, 52.6180510620694, 32.375968743603, 42.0671208740445, 44.8980312830359, 34.1636884387502, 36.5443594656413, 47.3128113809467 ),
  `Wirk_Brutto` = c( 0.21091819774276, 0.218687083170556, 0.218760618322075, 0.215611035633622, 0.214547147778117, 0.218930425263281, 0.227778316752638, 0.221045746532832, 0.241032841135073, 0.231877904887968, 0.241135116972538, 0.237391436703597, 0.231766180410934, 0.235455654830026, 0.225781269887199, 0.237080456805955, 0.238940307096781, 0.22236502148504, 0.223093734025061, 0.221665349290325, 0.225584494767251, 0.224321087908687, 0.226863452429123, 0.228356628526559, 0.210066541077549, 0.215613658605269, 0.214257766456576, 0.225374565032104, 0.226632861157903, 0.225342311634305, 0.202757163964259, 0.220274153111015, 0.221156816095123, 0.2037476019667, 0.219912947132494, 0.211113698805482, 0.231505614168667, 0.234285612923503, 0.235567631959634, 0.222650724211751, 0.231727760126706, 0.219734608022672, 0.225208598362406, 0.23752066449308, 0.24609162628488, 0.235239077451739, 0.23507782711413, 0.257565789353377, 0.196493707208499, 0.20725848437317, 0.212413076069613, 0.205403057940064, 0.218886073914972, 0.222063328733195 ),
  `Wirk_Netto` = c( 0.235366208704023, 0.24575401991436, 0.243091404958539, 0.238518403096868, 0.235435907276559, 0.240279695180822, 0.255934451435372, 0.248097421797994, 0.269612985904083, 0.258824217026203, 0.267696887307786, 0.264544459494061, 0.259459192084525, 0.264732681287629, 0.248201900922679, 0.261299577904801, 0.261524156177508, 0.242125397562104, 0.251321138621137, 0.250186487127734, 0.251530175390694, 0.250643819041199, 0.251705746605124, 0.25286873845261, 0.235236336194875, 0.242214059349332, 0.23731394539996, 0.249555183341606, 0.249068360041437, 0.247347607416278, 0.221558994244514, 0.243163021575891, 0.242168848169494, 0.221339658358084, 0.238068303279725, 0.227659204021592, 0.25865339661502, 0.263730596001978, 0.261320891591058, 0.245994762806019, 0.253547895823224, 0.239800952281731, 0.248645123409885, 0.263685769900833, 0.270630156183426, 0.257261586154533, 0.255302073344076, 0.281816507813529, 0.229914263078336, 0.245377374830505, 0.246568081428814, 0.237160085395944, 0.250569512513164, 0.254821599878365 ),
  `Wirk_Total` = c( 0.215050980096665, 0.218361213965118, 0.21743918934395, 0.210231759369089, 0.210052326032456, 0.220565206870156, 0.224120419796381, 0.220781351398079, 0.236416282347832, 0.222476343746092, 0.227738869937329, 0.224836096783589, 0.238697915485563, 0.233601219961414, 0.217999410562797, 0.230984992520443, 0.227076019064188, 0.214502300481599, 0.225555773878964, 0.219352301338166, 0.219846792958958, 0.220428214984546, 0.218092136279684, 0.220946373711054, 0.213005949212925, 0.218400909748379, 0.213344733685403, 0.225400741075485, 0.219843269599878, 0.218616391702131, 0.199460121420396, 0.220446212520149, 0.212466511624337, 0.197689880977766, 0.207646479631449, 0.198013299225654, 0.233318299679759, 0.239375318086974, 0.234519392583452, 0.220198847250673, 0.227970762256012, 0.214722135551155, 0.227447147538819, 0.239548486250032, 0.247162950474793, 0.234763503071659, 0.2229381955183, 0.24282867143177, 0.207891012768686, 0.228081605080525, 0.224262888819237, 0.211157426124462, 0.219182082639067, 0.227004603734556 ),
  `Wirk_Muskulär` = c( 0.236759931308537, 0.246060440608401, 0.242278598743508, 0.229631619431488, 0.231738880422805, 0.239606281503452, 0.235519448379419, 0.240751242958341, 0.248138483274488, 0.238973954766177, 0.239905278154682, 0.242987590176426, 0.253197378567756, 0.268813524126113, 0.246034674712508, 0.243007190386035, 0.237707989694929, 0.239357891786449, 0.246622974378944, 0.259752672010051, 0.237157651346767, 0.256082449948023, 0.248047661517146, 0.237373974289561, 0.25603524395526, 0.230241128289079, 0.252398922767891, 0.237853768450825, 0.236244609842595, 0.256844301131177, 0.229409310695982, 0.250592406029218, 0.239641017649487, 0.225830203382915, 0.230325301880732, 0.22455381609002, 0.2675313748833, 0.254378184934767, 0.247600833815352, 0.250156276904196, 0.239017863265009, 0.241462546103667, 0.252453992795637, 0.255683248260526, 0.261633090232167, 0.257132037314701, 0.242104726162168, 0.256054300732916, 0.235970111612527, 0.269069913213186, 0.259743624458201, 0.236785575354483, 0.242749525282335, 0.259138280507211 ),
  `Masse` = c( 76, 76, 76, 76, 76, 76, 73, 73, 73, 73, 73, 73, 82, 82, 82, 82, 82, 82, 72, 72, 72, 72, 72, 72, 76, 76, 76, 76, 76, 76, 65, 65, 65, 65, 65, 65, 80, 80, 80, 80, 80, 80, 48, 48, 48, 48, 48, 48, 60, 60, 60, 60, 60, 60 ),
  `P_mech` = c( 286.196809943666, 279.856121744776, 308.058185037385, 316.422860962335, 340.826183919876, 347.288435475183, 277.240209227733, 271.455328132766, 304.467347747788, 298.231190808954, 325.412992360824, 309.694617397985, 323.150737156769, 316.844325140231, 371.96441826512, 380.655666884463, 411.774528793808, 405.478497575611, 300.611680063499, 294.276254054958, 330.974610194196, 323.263418911815, 347.877528040632, 356.523758791993, 264.042555125073, 264.046097801302, 296.595675684983, 312.821367725728, 338.374812212103, 340.655624979066, 222.299144497093, 217.725388710054, 237.149862110928, 238.510476030676, 268.299540676442, 270.26756043723, 259.609504812067, 246.984706949108, 281.340838183762, 276.152650787485, 316.924535968906, 309.069638160985, 220.907452101768, 221.311649982903, 250.936106797992, 254.071699215572, 274.36729230484, 276.737918099592, 175.467181480606, 173.18153762583, 199.048429239061, 199.114857295449, 224.703097248925, 224.226593365666 ),
  `P_mech_kg` = c( 3.76574749925877, 3.68231739137863, 4.05339717154454, 4.16345869687283, 4.48455505157731, 4.56958467730504, 3.79781108531141, 3.71856613880502, 4.17078558558614, 4.08535877820485, 4.45771222412087, 4.24239201915048, 3.94086264825328, 3.86395518463696, 4.53615144225757, 4.64214227907881, 5.02164059504643, 4.94485972653184, 4.17516222310415, 4.08717019520775, 4.5968695860305, 4.48976970710854, 4.83163233389766, 4.95171887211102, 3.47424414638254, 3.47429076054345, 3.90257468006557, 4.11607062797011, 4.45230016068557, 4.48231085498771, 3.41998683841681, 3.34962136477006, 3.6484594170912, 3.66939193893347, 4.12768524117603, 4.15796246826507, 3.24511881015084, 3.08730883686386, 3.51676047729703, 3.45190813484356, 3.96155669961133, 3.86337047701231, 4.6022385854535, 4.61065937464381, 5.22783555829151, 5.29316040032442, 5.71598525635083, 5.76537329374149, 2.92445302467677, 2.88635896043051, 3.31747382065102, 3.31858095492415, 3.74505162081542, 3.73710988942776 ),
  `nD` = c( 76.6564376505317, 86.4007340902643, 86.151834718222, 76.9699534010204, 86.1492001342774, 77.7545030427186, 59.6696464126312, 79.340733311971, 59.0120747230942, 78.6315332132975, 58.5778147794659, 74.8376014062797, 64.4031353722102, 93.4309539387749, 93.4798136132308, 64.6513676939208, 63.9226666971842, 92.926017486389, 76.1787191980119, 100.725884150632, 76.4965310227163, 100.706804663599, 101.493737868195, 76.2895930915614, 94.9222147345463, 67.3025317640006, 95.6908060743521, 67.7563334376017, 68.9089393183102, 97.2326216948995, 82.3157999725342, 85.1151334584554, 84.9867423386037, 82.4121919818754, 85.6636667989095, 82.5434000701904, 88.3525337219238, 59.2843333028158, 59.6458305272363, 87.9682001902262, 59.0753999888102, 88.6749836398094, 86.1743334757487, 65.9431711942811, 65.5106667200724, 86.0812543343512, 85.3489333648682, 66.2728181161696, 75.2098000386556, 87.7106668141683, 88.0529021962314, 75.7959332733154, 75.7891333821615, 88.2820788795832 ),
  `VO2_kg_max` = c( 74.4, 74.4, 74.4, 74.4, 74.4, 74.4, 67.8, 67.8, 67.8, 67.8, 67.8, 67.8, 75.4, 75.4, 75.4, 75.4, 75.4, 75.4, 72, 72, 72, 72, 72, 72, 70.1, 70.1, 70.1, 70.1, 70.1, 70.1, 72.2, 72.2, 72.2, 72.2, 72.2, 72.2, 69.4, 69.4, 69.4, 69.4, 69.4, 69.4, 81.2, 81.2, 81.2, 81.2, 81.2, 81.2, 67.9, 67.9, 67.9, 67.9, 67.9, 67.9 ),
  `HR_percent` = c( 87.37, 85.07, 88.4, 90.93, 93.12, 93.78, 88.05, 88.16, 92.21, 91.97, 95.39, 93.58, 84.41, 84.65, 88.64, 89.98, 91.12, 94.04, 89.19, 89.26, 92.25, 92.32, 93.98, 94.9, 86.65, 87.88, 89.95, 91.14, 93.96, 94.27, 90.9, 86.55, 87.59, 91.62, 91.13, 95.12, 86.77, 87.49, 90.8, 89.74, 93.35, 94.18, 80.64, 81.03, 84.87, 88.21, 91.54, 92.47, 91.92, 88.36, 90.08, 92.49, 93.58, 93.31 ),
  `VO2_percent` = c( 71.27, 66.6, 72.84, 76.05, 83.97, 83.1, 73.17, 73.36, 75.13, 76.76, 82.17, 80.02, 65.96, 64.11, 76.98, 75.53, 81.19, 87.7, 77.06, 75.21, 82.91, 81.14, 86.2, 88.05, 69.58, 67.18, 76.09, 77.01, 83.24, 82.99, 68.97, 61.94, 67.21, 72.61, 75.89, 79.96, 59.98, 55.95, 63.85, 65.63, 72.7, 75.69, 74.64, 71.07, 77.24, 82.44, 89.64, 82.88, 64.16, 59.83, 66.38, 68.75, 72.98, 72.62 ),
  `VO2_avg` = c( 4.032, 3.768, 4.124, 4.28, 4.716, 4.705, 3.609, 3.626, 3.699, 3.783, 4.06, 3.944, 4.176, 3.944, 4.733, 4.652, 4.961, 5.401, 3.965, 3.902, 4.327, 4.195, 4.45, 4.554, 3.728, 3.61, 4.073, 4.095, 4.41, 4.485, 3.232, 2.946, 3.158, 3.407, 3.566, 3.743, 3.324, 3.125, 3.542, 3.637, 4.053, 4.185, 2.929, 2.802, 3.074, 3.208, 3.505, 3.222, 2.637, 2.436, 2.702, 2.802, 2.968, 2.96 ),
  `VO2_avg_kg` = c( 0.0530526315789474, 0.049578947368421, 0.0542631578947368, 0.0563157894736842, 0.0620526315789474, 0.0619078947368421, 0.0494383561643836, 0.0496712328767123, 0.0506712328767123, 0.0518219178082192, 0.0556164383561644, 0.054027397260274, 0.0509268292682927, 0.0480975609756098, 0.0577195121951219, 0.0567317073170732, 0.0605, 0.0658658536585366, 0.0550694444444444, 0.0541944444444444, 0.0600972222222222, 0.0582638888888889, 0.0618055555555556, 0.06325, 0.0490526315789474, 0.0475, 0.0535921052631579, 0.0538815789473684, 0.0580263157894737, 0.0590131578947368, 0.0497230769230769, 0.0453230769230769, 0.0485846153846154, 0.0524153846153846, 0.0548615384615385, 0.0575846153846154, 0.04155, 0.0390625, 0.044275, 0.0454625, 0.0506625, 0.0523125, 0.0610208333333333, 0.058375, 0.0640416666666667, 0.0668333333333333, 0.0730208333333333, 0.067125, 0.04395, 0.0406, 0.0450333333333333, 0.0467, 0.0494666666666667, 0.0493333333333333 ),
  `VO2_net_SS` = c( 4.004, 3.712, 4.167, 4.276, 4.986, 4.818, 3.509, 3.494, 3.652, 3.705, 4.014, 4.092, 4.042, 4.027, 4.776, 4.634, 5.108, 5.576, 3.858, 3.746, 4.22, 4.065, 4.479, 4.536, 3.587, 3.466, 3.964, 4.101, 4.406, 4.572, 3.182, 2.837, 3.145, 3.397, 3.596, 3.779, 3.279, 2.99, 3.517, 3.643, 4.162, 4.323, 2.776, 2.645, 2.962, 3.143, 3.468, 3.188, 2.384, 2.211, 2.493, 2.591, 2.812, 2.784 ),
  `VO2_net_SS_kg` = c( 0.0526842105263158, 0.0488421052631579, 0.0548289473684211, 0.0562631578947368, 0.0656052631578947, 0.0633947368421053, 0.0480684931506849, 0.0478630136986301, 0.050027397260274, 0.0507534246575342, 0.054986301369863, 0.0560547945205479, 0.0492926829268293, 0.049109756097561, 0.0582439024390244, 0.0565121951219512, 0.0622926829268293, 0.068, 0.0535833333333333, 0.0520277777777778, 0.0586111111111111, 0.0564583333333333, 0.0622083333333333, 0.063, 0.0471973684210526, 0.0456052631578947, 0.0521578947368421, 0.0539605263157895, 0.0579736842105263, 0.0601578947368421, 0.0489538461538462, 0.0436461538461538, 0.0483846153846154, 0.0522615384615385, 0.0553230769230769, 0.0581384615384615, 0.0409875, 0.037375, 0.0439625, 0.0455375, 0.052025, 0.0540375, 0.0578333333333333, 0.0551041666666667, 0.0617083333333333, 0.0654791666666667, 0.07225, 0.0664166666666667, 0.0397333333333333, 0.03685, 0.04155, 0.0431833333333333, 0.0468666666666667, 0.0464 ),
  `W_Aerob` = c( 364.789166022847, 341.629555246705, 380.175743058369, 397.985468023398, 434.291677759482, 433.605222297912, 324.974079503018, 328.244436599334, 338.782659218172, 345.676143718918, 364.680735327353, 257.547695226202, 373.643424879889, 359.053884392895, 449.590938122183, 437.033618580678, 472.355442968317, 502.398965566933, 358.837718601139, 352.868283295468, 394.753364696823, 386.919677670582, 414.624059322391, 422.974893188083, 336.736950672026, 327.040591917684, 374.940893404024, 376.054742927363, 407.568603441812, 413.170309433097, 301.002193914676, 268.616569204091, 293.782454560316, 323.273033581013, 338.095668739063, 356.147551686419, 301.108945263692, 280.951141839367, 322.983175747043, 336.778695169108, 374.987772949063, 386.657728278586, 266.533422098459, 251.790208549518, 278.168675291213, 296.280182766526, 322.403130586883, 294.593727223427, 228.955584309471, 211.732892340367, 242.182720592561, 251.873990890611, 269.030850954527, 263.980675271676 ),
  `W_PCR` = c( 24.1291998261524, 31.245535169392, 29.1930235666251, 40.7334747429318, 32.1503897341314, 31.0960321619306, 35.5542282425247, 29.8757643229022, 32.3919515398355, 37.4564805468453, 39.181054527315, 28.0856376372225, 25.6241011760421, 42.2362045296838, 43.8865576245131, 46.7522391886717, 55.8553450423781, 41.2539914795555, 33.5030632789753, 39.5610791298099, 47.0313952643199, 43.4984491855838, 48.5683623835727, 47.4643724094369, 28.7114346014479, 27.082865453765, 33.5487723155105, 28.4952050444725, 46.7129326531457, 36.4259657605345, 26.4583220374129, 20.1814127976726, 29.9859705398912, 25.6937955351603, 32.5159707007087, 35.3146550491163, 26.041151647366, 18.4426421779503, 25.8050373268292, 31.1359690227005, 24.1696808725351, 31.9239901224492, 18.2312728474559, 19.2851143909574, 15.5481731391339, 15.0049470739965, 26.5074844823288, 32.024059076605, 19.4890043814307, 11.8721280138382, 16.7847021024629, 20.5569026538069, 25.1374379120318, 20.8232926492238 ),
  `W_TOT` = c( 399.249717181043, 384.486031190706, 425.026674308594, 451.534337978137, 486.77325839355, 472.361584680434, 371.104350259043, 368.856327421404, 386.353272360279, 402.152227675927, 428.665944180332, 303.033262017248, 406.141884187901, 406.904114446707, 511.87902385356, 494.390128203813, 544.013230226759, 567.096711781505, 399.827955933609, 402.470708891198, 451.643536491319, 439.95740599879, 478.52829630846, 484.086368294384, 371.880535873387, 362.699172964313, 417.065381312399, 416.353601456395, 461.749153605597, 467.47037904168, 334.351262168179, 296.297295681804, 334.852575539387, 361.946410485473, 387.629312790631, 409.468800571675, 333.805156091563, 309.536558225317, 359.894550831632, 376.231739042368, 417.059450298718, 431.818038742475, 291.374221869366, 277.160987465275, 304.579759607115, 324.673591795083, 369.20630625942, 341.89280425728, 253.210342011047, 227.788914715005, 266.270220124784, 282.890629446418, 307.556750821119, 296.32869511474 ),
  `W_BLC` = c( 10.3313513320441, 11.610940774608, 15.6579076836, 12.815395211808, 20.331190899936, 7.660330220592, 10.5760425135007, 10.736126499168, 15.178661602272, 19.019603410164, 24.804154325664, 17.399929153824, 6.87435813197033, 5.614025524128, 18.401528106864, 10.604270434464, 15.802442216064, 23.443754735016, 7.48717405349485, 10.04134646592, 9.858776530176, 9.539279142624, 15.335874602496, 13.647102696864, 6.43215059991284, 8.575715592864, 8.575715592864, 11.80365348456, 7.46761751064, 17.874103848048, 6.89074621609046, 7.49931368004, 11.08415043918, 12.9795813693, 17.01767335086, 18.00659383614, 6.65505918050507, 10.142774208, 11.10633775776, 8.31707485056, 17.90199647712, 13.23632034144, 6.60952692345146, 6.0856645248, 10.862911176768, 13.38846195456, 20.295691190208, 15.275017957248, 4.76575332014558, 4.1838943608, 7.30279742976, 10.459735902, 13.38846195456, 11.52472719384 )
  , check.names = FALSE
)


# Auswahl der gewünschten Variablen
selected_vars <- c("Torque_Efficiency", "Pedal_Smoothness", 
                   "Wirk_Brutto", "Wirk_Netto", "Wirk_Total", "Wirk_Muskulär",
                   "W_Aerob", "W_PCR", "W_TOT", "W_BLC",
                   "Masse", "nD", 
                   "P_mech", "P_mech_kg", "VO2_max", "VO2_kg_max", "VO2_avg","VO2_avg_kg", "VO2_net_SS","VO2_net_SS_kg", "HR_percent", "VO2_percent")

# Datenbereinigung
Bedingungen_data_Shiny_Regression<- Bedingungen_data_Shiny_Regression%>%
  # Konvertiere Proband zu Faktor
  mutate(Proband = as.factor(Proband),
         Bedingung = as.factor(Bedingung),
         Intensität = as.factor(Intensität))

# UI
ui <- fluidPage(
  tags$head(
    tags$style(HTML("
      .well {
        max-height: 70vh;  /* Begrenzen Sie die Höhe auf 70% der Viewporthöhe */
        overflow-y: auto;  /* Ermöglichen Sie vertikales Scrollen */
        overflow-x: hidden; /* Verstecken Sie horizontales Scrollen */
      }
    "))
  ),
  
  titlePanel("Interaktive Regressionsanalyse"),
  
  fluidRow(
    column(3,
           wellPanel(
             selectInput("x_variable", "X-Achse:", 
                         choices = selected_vars,
                         selected = "Torque_Efficiency"),  # Standard X-Achse
             selectInput("y_variable", "Y-Achse:", 
                         choices = selected_vars,
                         selected = "Wirk_Total"),  # Standard Y-Achse
             
             checkboxGroupInput("selectedBedingung", "Bedingungen:",
                                choices = levels(Bedingungen_data_Shiny_Regression$Bedingung),
                                selected = levels(Bedingungen_data_Shiny_Regression$Bedingung)),
             
             checkboxGroupInput("selectedIntensität", "Intensitäten:",
                                choices = levels(Bedingungen_data_Shiny_Regression$Intensität),
                                selected = levels(Bedingungen_data_Shiny_Regression$Intensität)),
             
             checkboxGroupInput("selectedProband", "Probanden:",
                                choices = levels(Bedingungen_data_Shiny_Regression$Proband),
                                selected = levels(Bedingungen_data_Shiny_Regression$Proband))
           )
    ),
    column(9,
           plotlyOutput("regressionPlot", height = "calc(65vh - 150px)")
    )
  ),
  
  fluidRow(
    column(12,
           DTOutput("summaryTable"),
           br(), br()
    )
  )
)

server <- function(input, output, session) {
  
  filtered_data <- reactive({
    req(input$x_variable, input$y_variable)
    
    Bedingungen_data_Shiny_Regression%>%
      filter(Proband %in% input$selectedProband,
             Bedingung %in% input$selectedBedingung,
             Intensität %in% input$selectedIntensität)
  })
  
  # Regression Modell
  regression_model <- reactive({
    data <- filtered_data()
    
    # Sicherstellen, dass Variablen numerisch sind
    x_var <- input$x_variable
    y_var <- input$y_variable
    
    formula <- as.formula(paste(y_var, "~", x_var))
    
    # Fehlerbehandlung für Regression
    tryCatch({
      lm(formula, data = data)
    }, error = function(e) {
      message("Fehler bei der Regressionsberechnung: ", e$message)
      NULL
    })
  })
  
  output$regressionPlot <- renderPlotly({
    req(input$x_variable, input$y_variable)
    
    data <- filtered_data()
    
    # Prüfe, ob genug Datenpunkte vorhanden sind
    req(nrow(data) > 2)
    
    # Lineare Regression
    lin_reg <- regression_model()
    
    req(!is.null(lin_reg))
    
    # Regressionsstatistiken
    reg_summary <- summary(lin_reg)
    reg_coefficients <- coef(lin_reg)
    
    # Formatierte Regressionsergebnisse
    equation_text <- sprintf("%s(%s) = %.4f · %s + %.4f", 
                             input$y_variable,
                             input$x_variable,
                             reg_coefficients[input$x_variable], 
                             input$x_variable,
                             reg_coefficients["(Intercept)"])
    r_squared_text <- sprintf("R² = %.4f", reg_summary$r.squared)
    
    # F-Statistik und p-Wert
    f_stat <- reg_summary$fstatistic
    p_value <- pf(f_stat["value"], f_stat["numdf"], f_stat["dendf"], lower.tail = FALSE)
    f_stat_text <- sprintf("F (%d, %d) = %.4f, p = %.7f", 
                           f_stat["numdf"], f_stat["dendf"], 
                           f_stat["value"], p_value)
    
    # Sequenz für Regressionslinie
    x_seq <- seq(min(data[[input$x_variable]], na.rm = TRUE), 
                 max(data[[input$x_variable]], na.rm = TRUE), 
                 length.out = 100)
    regression_data <- data.frame(x = x_seq)
    names(regression_data) <- input$x_variable
    regression_values <- predict(lin_reg, newdata = regression_data)
    
    # Plotly-Diagramm
    plot_ly() %>%
      add_markers(data = data, 
                  x = as.formula(paste0("~", input$x_variable)), 
                  y = as.formula(paste0("~", input$y_variable)), 
                  type = 'scatter', 
                  mode = 'markers',
                  color = ~Proband, 
                  colors = colorRampPalette(brewer.pal(10,"Spectral"))(length(unique(data$Proband))),
                  marker = list(size = 9, opacity = 0.8)) %>%
      layout(
        title = paste(input$y_variable, "vs.", input$x_variable),
        margin = list(t = 40), 
        xaxis = list(title = input$x_variable),
        yaxis = list(title = input$y_variable)
      ) %>%
      add_lines(x = ~x_seq, y = ~regression_values, 
                name = "Regressionslinie", 
                line = list(color = 'darkgrey', width = 2)) %>%
      add_annotations(
        text = equation_text, 
        x = min(data[[input$x_variable]], na.rm = TRUE), 
        y = max(data[[input$y_variable]], na.rm = TRUE), 
        showarrow = FALSE, 
        xanchor = 'left', 
        yanchor = 'bottom'
      ) %>%
      add_annotations(
        text = r_squared_text, 
        x = min(data[[input$x_variable]], na.rm = TRUE), 
        y = min(data[[input$y_variable]], na.rm = TRUE) + 
          (max(data[[input$y_variable]], na.rm = TRUE) - 
             min(data[[input$y_variable]], na.rm = TRUE)) * 0.94, 
        showarrow = FALSE, 
        xanchor = 'left', 
        yanchor = 'bottom'
      ) %>%
      add_annotations(
        text = f_stat_text, 
        x = min(data[[input$x_variable]], na.rm = TRUE), 
        y = min(data[[input$y_variable]], na.rm = TRUE) + 
          (max(data[[input$y_variable]], na.rm = TRUE) - 
             min(data[[input$y_variable]], na.rm = TRUE)) * 0.88, 
        showarrow = FALSE, 
        xanchor = 'left', 
        yanchor = 'bottom'
      )
  })
  
  # Platzhalter für summaryTable
  output$summaryTable <- renderDT({
    # Hier können Sie später die Tabelle implementieren
    NULL
  })
}

shinyApp(ui, server)