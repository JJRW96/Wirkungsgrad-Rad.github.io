library(shiny)
library(shinylive)
library(DT)
library(dplyr)
library(plotly)

Erg_data_short <- data.frame(
  `Proband` = c( 1, 1, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 10, 10, 10, 10, 10, 10, 13, 13, 13, 13, 13, 13, 15, 15, 15, 15, 15, 15, 19, 19, 19, 19, 19, 19, 20, 20, 20, 20, 20, 20, 22, 22, 22, 22, 22, 22, 23, 23, 23, 23, 23, 23 ),
  `Nr` = c( 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6 ),
  `Bedingung` = c( "stehen", "sitzen", "sitzen", "stehen", "sitzen", "stehen", "stehen", "sitzen", "stehen", "sitzen", "stehen", "sitzen", "stehen", "sitzen", "sitzen", "stehen", "stehen", "sitzen", "stehen", "sitzen", "stehen", "sitzen", "sitzen", "stehen", "sitzen", "stehen", "sitzen", "stehen", "stehen", "sitzen", "stehen", "sitzen", "sitzen", "stehen", "sitzen", "stehen", "sitzen", "stehen", "stehen", "sitzen", "stehen", "sitzen", "sitzen", "stehen", "stehen", "sitzen", "sitzen", "stehen", "stehen", "sitzen", "sitzen", "stehen", "stehen", "sitzen" ),
  `Intensität` = c( "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer", "leicht", "leicht", "moderat", "moderat", "schwer", "schwer" ),
  `nD_Vorgabe [U·min⁻¹]` = c( 77, 84, 84, 77, 84, 77, 59, 79, 59, 79, 59, 79, 62, 92, 92, 62, 62, 92, 76, 100, 76, 100, 100, 76, 95, 67, 95, 67, 67, 95, 83, 85, 85, 83, 85, 83, 88, 59, 59, 88, 59, 88, 85, 64, 64, 85, 85, 64, 75, 88, 88, 75, 75, 88 ),
  `nD [U·min⁻¹]` = c( 76.6564376505317, 86.4007340902643, 86.151834718222, 76.9699534010204, 86.1492001342774, 77.7545030427186, 59.6696464126312, 79.340733311971, 59.0120747230942, 78.6315332132975, 58.5778147794659, 74.8376014062797, 64.4031353722102, 93.4309539387749, 93.4798136132308, 64.6513676939208, 63.9226666971842, 92.926017486389, 76.1787191980119, 100.725884150632, 76.4965310227163, 100.706804663599, 101.493737868195, 76.2895930915614, 94.9222147345463, 67.3025317640006, 95.6908060743521, 67.7563334376017, 68.9089393183102, 97.2326216948995, 82.3157999725342, 85.1151334584554, 84.9867423386037, 82.4121919818754, 85.6636667989095, 82.5434000701904, 88.3525337219238, 59.2843333028158, 59.6458305272363, 87.9682001902262, 59.0753999888102, 88.6749836398094, 86.1743334757487, 65.9431711942811, 65.5106667200724, 86.0812543343512, 85.3489333648682, 66.2728181161696, 75.2098000386556, 87.7106668141683, 88.0529021962314, 75.7959332733154, 75.7891333821615, 88.2820788795832 ),
  `P_mech_Vorgabe [W]` = c( 290, 290, 320, 320, 350, 350, 280, 280, 305, 305, 325, 325, 325, 325, 380, 380, 410, 410, 305, 305, 335, 335, 360, 360, 270, 270, 305, 305, 330, 330, 225, 225, 245, 245, 275, 275, 250, 250, 280, 280, 315, 315, 230, 230, 260, 260, 280, 280, 185, 185, 210, 210, 235, 235 ),
  `P_mech [W]` = c( 286.196809943666, 279.856121744776, 308.058185037385, 316.422860962335, 340.826183919876, 347.288435475183, 277.240209227733, 271.455328132766, 304.467347747788, 298.231190808954, 325.412992360824, 309.694617397985, 323.150737156769, 316.844325140231, 371.96441826512, 380.655666884463, 411.774528793808, 405.478497575611, 300.611680063499, 294.276254054958, 330.974610194196, 323.263418911815, 347.877528040632, 356.523758791993, 264.042555125073, 264.046097801302, 296.595675684983, 312.821367725728, 338.374812212103, 340.655624979066, 222.299144497093, 217.725388710054, 237.149862110928, 238.510476030676, 268.299540676442, 270.26756043723, 259.609504812067, 246.984706949108, 281.340838183762, 276.152650787485, 316.924535968906, 309.069638160985, 220.907452101768, 221.311649982903, 250.936106797992, 254.071699215572, 274.36729230484, 276.737918099592, 175.467181480606, 173.18153762583, 199.048429239061, 199.114857295449, 224.703097248925, 224.226593365666 ),
  `P_mech_kg [W·kg⁻¹]` = c( 3.76574749925876, 3.68231739137862, 4.05339717154454, 4.16345869687283, 4.48455505157731, 4.56958467730504, 3.79781108531141, 3.71856613880502, 4.17078558558614, 4.08535877820485, 4.45771222412087, 4.24239201915048, 3.94086264825329, 3.86395518463696, 4.53615144225757, 4.64214227907881, 5.02164059504643, 4.94485972653184, 4.17516222310415, 4.08717019520774, 4.5968695860305, 4.48976970710854, 4.83163233389766, 4.95171887211102, 3.47424414638254, 3.47429076054345, 3.90257468006557, 4.11607062797011, 4.45230016068557, 4.48231085498771, 3.41998683841681, 3.34962136477006, 3.6484594170912, 3.66939193893347, 4.12768524117603, 4.15796246826507, 3.24511881015084, 3.08730883686386, 3.51676047729703, 3.45190813484356, 3.96155669961133, 3.86337047701231, 4.6022385854535, 4.61065937464381, 5.22783555829151, 5.29316040032442, 5.71598525635083, 5.7653732937415, 2.92445302467677, 2.88635896043051, 3.31747382065102, 3.31858095492415, 3.74505162081542, 3.73710988942776 ),
  `Torque Efficiency [%]` = c( 66.42, 80.67, 85.6, 72.95, 87.65, 78.67, 80.04, 86.41, 86.78, 88.63, 88.24, 92.41, 73.99, 73.77, 81.11, 85.39, 91.79, 84.47, 72.05, 72.34, 79.17, 76.95, 79.78, 85.17, 66.52, 69.93, 72.41, 82.58, 87.01, 79.53, 65.43, 72.54, 77.02, 70.47, 80.77, 78.76, 64.47, 62.05, 68.4, 71.35, 77.44, 75.1, 81.99, 82.22, 91.47, 89.76, 92.56, 97.11, 50.58, 59.59, 65.12, 56.31, 63.19, 72.06 ),
  `P_mech_abs [W]` = c( 430.898453269453, 346.932268431489, 359.894794521274, 433.727303347072, 388.867195271955, 441.471798101275, 346.379136378951, 314.139111107741, 350.86692910731, 336.501760889012, 368.792501882788, 335.122366938868, 436.74295487819, 429.476010923678, 458.572565130538, 445.785439492691, 448.616125076261, 480.02899009992, 417.254676419948, 406.786522182967, 418.029194795729, 420.068975285005, 436.036881620291, 418.609977742272, 396.931552233338, 377.562076360227, 409.578155842889, 378.797651732435, 388.906717354007, 428.323957484394, 339.738475124735, 300.163566795685, 307.893824314181, 338.470207382618, 332.172517017126, 343.174345545978, 402.65419504435, 398.061154186489, 411.292076398934, 387.025904346715, 409.236247070283, 411.542819605474, 269.447435024309, 269.166149547195, 274.335758746147, 283.051443499869, 296.406742555017, 284.967630696716, 346.914329776961, 290.644914064715, 305.65464771739, 353.590906241965, 355.615760249487, 311.181510014167 ),
  `P_max [W]` = c( 720.71392917246, 550.697854561856, 587.417097655553, 787.012012890423, 634.931737852808, 846.118844347542, 578.609811212814, 526.754221690469, 618.616237792837, 583.178213938422, 677.46839262409, 586.294927750192, 674.210503713599, 609.931100907041, 688.050026599798, 751.453351178328, 782.342779552722, 747.114860859711, 697.739178615104, 599.783453121439, 741.044102327642, 642.75054953451, 678.261118990867, 767.313623578198, 546.342710728637, 596.59219640589, 563.098821554568, 659.349421443241, 701.336341167984, 587.602874558339, 523.918403061563, 432.932490041913, 452.947736533387, 558.40548473631, 513.309499380782, 603.361877693434, 560.027085542369, 643.90077383047, 709.354344682915, 560.027686195494, 751.218524473997, 600.371875917469, 405.818662295843, 446.750025682425, 484.017990617248, 441.823569590808, 475.691772431568, 525.937225940098, 541.967355078066, 411.679083397134, 443.334425922299, 582.825995654505, 614.87764605695, 473.923630452372 ),
  `P_max_kg [W·kg⁻¹]` = c( 9.4830780154271, 7.24602440212969, 7.72917233757307, 10.3554212222424, 8.35436497174747, 11.1331426887834, 7.92616179743581, 7.21581125603382, 8.47419503825805, 7.98874265669071, 9.28038894005602, 8.03143736644098, 8.22207931358047, 7.43818415740294, 8.39085398292436, 9.1640652582723, 9.54076560430149, 9.11115683975258, 9.69082192520977, 8.33032573779776, 10.292279198995, 8.92709096575709, 9.4202933193176, 10.6571336608083, 7.18871987800839, 7.84989732113013, 7.40919502045484, 8.6756502821479, 9.22810975221031, 7.73161677050446, 8.06028312402404, 6.66049984679866, 6.96842671589827, 8.59085361132785, 7.8970692212428, 9.28249042605283, 7.00033856927961, 8.04875967288088, 8.86692930853643, 7.00034607744368, 9.39023155592496, 7.50464844896836, 8.45455546449672, 9.30729220171718, 10.0837081378593, 9.20465769980849, 9.91024525899101, 10.9570255404187, 9.0327892513011, 6.86131805661889, 7.38890709870498, 9.71376659424175, 10.2479607676158, 7.8987271742062 ),
  `Pedal_Smoothness [%]` = c( 39.710181579574, 50.8184514296743, 52.4428359792181, 40.2055948041026, 53.6791852731242, 41.0448765909455, 47.914882163269, 51.5335837768147, 49.217483982331, 51.1389458112447, 48.0336788998195, 52.8223258874823, 47.9302436519206, 51.9475600881879, 54.0606647605687, 50.6559277814877, 52.6335181401208, 54.2725782631366, 43.083675000186, 49.0637500123524, 44.6632810590617, 50.293760020264, 51.2896166830574, 46.4638901013413, 48.3291073423363, 44.2590599394396, 52.6720469537052, 47.4439436135393, 48.2471522363413, 57.9737846304978, 42.4301080469913, 50.2908406548503, 52.3570034648903, 42.7127745966365, 52.2685711057555, 44.7936090146139, 46.3565980135841, 38.3575726240913, 39.6615373251182, 49.3105354600425, 42.1880618813037, 51.4796995926358, 54.4350155934243, 49.538139286023, 51.844375965857, 57.5052389013286, 57.6775357922151, 52.6180510620694, 32.375968743603, 42.0671208740445, 44.8980312830359, 34.1636884387502, 36.5443594656413, 47.3128113809467 ),
  `P_L_percent [%]` = c( 48.33, 50.2, 50.31, 48.74, 50.1, 49.16, 48.83, 47.25, 48.87, 47.74, 48.51, 48.13, 49.1, 47.89, 48.24, 49.08, 49.15, 48.32, 50.47, 51.64, 50.42, 52.2, 52.58, 50.35, 48.94, 48.97, 48.42, 48.87, 48.36, 48.81, 46.98, 47.29, 46.58, 45.97, 46.3, 45.61, 48.33, 47.48, 47.28, 47.99, 47.43, 48.98, 46.68, 47.57, 47.92, 46.93, 47.05, 47.83, 47.46, 48.28, 48.55, 47.93, 47.89, 47.39 ),
  `P_R_percent [%]` = c( 51.67, 49.8, 49.69, 51.26, 49.9, 50.84, 51.17, 52.75, 51.13, 52.26, 51.49, 51.87, 50.9, 52.11, 51.76, 50.92, 50.85, 51.68, 49.53, 48.36, 49.58, 47.8, 47.42, 49.65, 51.06, 51.03, 51.58, 51.13, 51.64, 51.19, 53.02, 52.71, 53.42, 54.03, 53.7, 54.39, 51.67, 52.52, 52.72, 52.01, 52.57, 51.02, 53.32, 52.43, 52.08, 53.07, 52.95, 52.17, 52.54, 51.72, 51.45, 52.07, 52.11, 52.61 ),
  `P_Int_Kinematik [W]` = c( NA, NA, NA, NA, NA, NA, 14.100763652975, 24.5534028664068, 15.0963689575941, 22.1151700768599, 17.3844162192499, 25.0023011514367, NA, NA, NA, NA, NA, NA, NA, 54.1998860792695, 26.061124339902, 52.2878157580086, 47.7818881896929, 26.5079250128008, 53.3391906234455, 14.3147915747616, 54.2938342051136, 17.2828759891928, 25.244349916907, 59.5680510358891, 33.3784974506853, 29.7741187061253, 30.3315111051071, 33.950962281492, 29.3032542779672, 36.2250453566804, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA ),
  `P_Int_Modell [W]` = c( 25.0030113782592, 35.8012933947664, 35.4927795606203, 25.3110458399501, 35.4895234774056, 26.0929432321431, 11.2772822919912, 26.5114016434881, 10.908542042465, 25.8068079920113, 10.6694874822585, 22.2486486488368, 15.741500125853, 48.0615124768915, 48.1369531524429, 15.9242224196747, 15.3918115611545, 47.2864879922241, 24.1895549833046, 55.9178086672442, 24.4935707465672, 55.8860388484466, 57.2064003074772, 24.2953284415851, 49.517125323862, 17.6500541105649, 50.7297211471405, 18.0094946189141, 18.9442986410243, 53.2215873863158, 26.7383367968065, 29.5600478833988, 29.426480838279, 26.832378813769, 30.1352473609116, 26.960742100465, 38.3697440266419, 11.5918218313976, 11.8051673274201, 37.8711938502897, 11.4696955201592, 38.7913797975227, 24.5892412580504, 11.0184578439549, 10.8030749020779, 24.509648850606, 23.8894209404426, 11.1845275722562, 19.8117633448399, 31.4236817494841, 31.7929519602614, 20.2785801635611, 20.2731228878915, 32.0418426886057 ),
  `P_Int_Kinematik_Modell [W]` = c( 28.8909754387892, 35.4998857304255, 35.1913718962795, 29.1990099004802, 35.1881158130648, 29.9809072926731, 14.100763652975, 24.5534028664068, 15.0963689575941, 22.1151700768599, 17.3844162192499, 25.0023011514367, 19.629464186383, 47.7601048125507, 47.8355454881021, 19.8121864802047, 19.2797756216845, 46.9850803278833, 28.0775190438347, 54.1998860792695, 26.061124339902, 52.2878157580086, 47.7818881896929, 26.5079250128008, 53.3391906234455, 14.3147915747616, 54.2938342051136, 17.2828759891928, 25.244349916907, 59.5680510358891, 33.3784974506853, 29.7741187061253, 30.3315111051071, 33.950962281492, 29.3032542779672, 36.2250453566804, 38.0683363623011, 15.4797858919276, 15.6931313879501, 37.5697861859489, 15.3576595806892, 38.4899721331819, 24.2878335937096, 14.9064219044849, 14.6910389626079, 24.2082411862652, 23.5880132761018, 15.0724916327862, 23.6997274053699, 31.1222740851432, 31.4915442959206, 24.1665442240911, 24.1610869484215, 31.7404350242649 ),
  `P_Int_Minetti [W]` = c( 30.9809373585523, 49.9999708568148, 49.4263049800275, 31.4908886354531, 49.4202592921155, 32.7945911926717, 10.9250427921879, 34.1502690837115, 10.4513604007798, 32.9455122957744, 10.1471003487607, 27.0326566244167, 16.6543744575556, 73.767219490831, 73.9216467087448, 16.9126300356257, 16.1629198459443, 72.185435664816, 28.625533659378, 87.4950086871089, 29.1062255383483, 87.428734336969, 90.1936400656646, 28.7925493361139, 72.8402574683913, 18.4088063094599, 75.2282351623464, 18.9103517783538, 20.230298081739, 80.1951316996545, 35.2316188202468, 40.2742001193818, 40.0317444559969, 35.3969341720174, 41.3224846452969, 35.6228942945399, 57.5509437920342, 11.666381586295, 11.9535465499954, 56.5560724625932, 11.5027875753635, 58.3957020942879, 31.2492356208192, 10.715365279786, 10.4370014598679, 31.1144417567931, 30.0690743189332, 10.931239773695, 22.663940206268, 41.9225151672263, 42.5806590146702, 23.3787506423065, 23.370362246721, 43.0256941239315 ),
  `Koerperlaenge [m]` = c( 1.83, 1.83, 1.83, 1.83, 1.83, 1.83, 1.84, 1.84, 1.84, 1.84, 1.84, 1.84, 1.8, 1.8, 1.8, 1.8, 1.8, 1.8, 1.79, 1.79, 1.79, 1.79, 1.79, 1.79, 1.76, 1.76, 1.76, 1.76, 1.76, 1.76, 1.76, 1.76, 1.76, 1.76, 1.76, 1.76, 1.86, 1.86, 1.86, 1.86, 1.86, 1.86, 1.57, 1.57, 1.57, 1.57, 1.57, 1.57, 1.63, 1.63, 1.63, 1.63, 1.63, 1.63 ),
  `Masse [kg]` = c( 76, 76, 76, 76, 76, 76, 73, 73, 73, 73, 73, 73, 82, 82, 82, 82, 82, 82, 72, 72, 72, 72, 72, 72, 76, 76, 76, 76, 76, 76, 65, 65, 65, 65, 65, 65, 80, 80, 80, 80, 80, 80, 48, 48, 48, 48, 48, 48, 60, 60, 60, 60, 60, 60 ),
  `lBein [m]` = c( 0.893, 0.893, 0.893, 0.893, 0.893, 0.893, 0.906, 0.906, 0.906, 0.906, 0.906, 0.906, 0.876, 0.876, 0.876, 0.876, 0.876, 0.876, 4.23, 4.23, 4.23, 4.23, 4.23, 4.23, 0.851, 0.851, 0.851, 0.851, 0.851, 0.851, 0.851, 0.851, 0.851, 0.851, 0.851, 0.851, 0.925, 0.925, 0.925, 0.925, 0.925, 0.925, 0.749, 0.749, 0.749, 0.749, 0.749, 0.749, 0.78, 0.78, 0.78, 0.78, 0.78, 0.78 ),
  `lOS [m]` = c( 0.439, 0.439, 0.439, 0.439, 0.439, 0.439, 0.446, 0.446, 0.446, 0.446, 0.446, 0.446, 0.427, 0.427, 0.427, 0.427, 0.427, 0.427, 0.423, 0.423, 0.423, 0.423, 0.423, 0.423, 0.412, 0.412, 0.412, 0.412, 0.412, 0.412, 0.412, 0.412, 0.412, 0.412, 0.412, 0.412, 0.458, 0.458, 0.458, 0.458, 0.458, 0.458, 0.359, 0.359, 0.359, 0.359, 0.359, 0.359, 0.379, 0.379, 0.379, 0.379, 0.379, 0.379 ),
  `lUS [m]` = c( 0.582305761606392, 0.582305761606392, 0.582305761606392, 0.582305761606392, 0.582305761606392, 0.582305761606392, 0.590793534155546, 0.590793534155546, 0.590793534155546, 0.590793534155546, 0.590793534155546, 0.590793534155546, 0.567571140915392, 0.567571140915392, 0.567571140915392, 0.567571140915392, 0.567571140915392, 0.567571140915392, 0.561751724518937, 0.561751724518937, 0.561751724518937, 0.561751724518937, 0.561751724518937, 0.561751724518937, 0.547909664087065, 0.547909664087065, 0.547909664087065, 0.547909664087065, 0.547909664087065, 0.547909664087065, 0.547909664087065, 0.547909664087065, 0.547909664087065, 0.547909664087065, 0.547909664087065, 0.547909664087065, 0.605978547475074, 0.605978547475074, 0.605978547475074, 0.605978547475074, 0.605978547475074, 0.605978547475074, 0.470545428200083, 0.470545428200083, 0.470545428200083, 0.470545428200083, 0.470545428200083, 0.470545428200083, 0.496883286094431, 0.496883286094431, 0.496883286094431, 0.496883286094431, 0.496883286094431, 0.496883286094431 ),
  `uOS [m]` = c( 0.586, 0.586, 0.586, 0.586, 0.586, 0.586, 0.576, 0.576, 0.576, 0.576, 0.576, 0.576, 0.617, 0.617, 0.617, 0.617, 0.617, 0.617, 0.565, 0.565, 0.565, 0.565, 0.565, 0.565, 0.586, 0.586, 0.586, 0.586, 0.586, 0.586, 0.532, 0.532, 0.532, 0.532, 0.532, 0.532, 0.602, 0.602, 0.602, 0.602, 0.602, 0.602, 0.509, 0.509, 0.509, 0.509, 0.509, 0.509, 0.579, 0.579, 0.579, 0.579, 0.579, 0.579 ),
  `uUS [m]` = c( 0.372, 0.372, 0.372, 0.372, 0.372, 0.372, 0.367, 0.367, 0.367, 0.367, 0.367, 0.367, 0.387, 0.387, 0.387, 0.387, 0.387, 0.387, 0.362, 0.362, 0.362, 0.362, 0.362, 0.362, 0.372, 0.372, 0.372, 0.372, 0.372, 0.372, 0.346, 0.346, 0.346, 0.346, 0.346, 0.346, 0.38, 0.38, 0.38, 0.38, 0.38, 0.38, 0.32, 0.32, 0.32, 0.32, 0.32, 0.32, 0.354, 0.354, 0.354, 0.354, 0.354, 0.354 ),
  `lKurbel [m]` = c( 0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.17, 0.17, 0.17, 0.17, 0.17, 0.17, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725, 0.1725 )
  , check.names = FALSE
)

# UI Definition
ui <- fluidPage(
  titlePanel("Ergometer Daten Analyse"),
  
  sidebarLayout(
    sidebarPanel(
      width = 2,
      style = "height: 90vh; overflow-y: auto;",
      radioButtons("viewType", "Datenansicht:",
                   choices = c("Einzelwerte" = "individual",
                               "Mittelwerte & BP" = "means"),
                   selected = "means"),
      checkboxGroupInput("selectedBedingung", "Bedingungen:",
                         choices = unique(Erg_data_short$Bedingung),
                         selected = unique(Erg_data_short$Bedingung)),
      checkboxGroupInput("selectedIntensität", "Intensitäten:",
                         choices = unique(Erg_data_short$Intensität),
                         selected = unique(Erg_data_short$Intensität)),
      radioButtons("selectedVariable", "Variable für Boxplot:",
                   choices = c(
                     "nD_Vorgabe [U·min⁻¹]" = "nD_Vorgabe [U·min⁻¹]",
                     "nD [U·min⁻¹]" = "nD [U·min⁻¹]",
                     "P_mech_Vorgabe [W]" = "P_mech_Vorgabe [W]",
                     "P_mech [W]" = "P_mech [W]",
                     "P_mech_kg [W·kg⁻¹]" = "P_mech_kg [W·kg⁻¹]",
                     "Torque Efficiency [%]" = "Torque Efficiency [%]",
                     "P_mech_abs [W]" = "P_mech_abs [W]",
                     "P_max [W]" = "P_max [W]",
                     "P_max_kg [W·kg⁻¹]" = "P_max_kg [W·kg⁻¹]",
                     "Pedal_Smoothness [%]" = "Pedal_Smoothness [%]",
                     "P_Int_Kinematik [W]" = "P_Int_Kinematik [W]",
                     "P_Int_Modell [W]" = "P_Int_Modell [W]",
                     "P_Int_Kinematik_Modell [W]" = "P_Int_Kinematik_Modell [W]",
                     "P_Int_Minetti [W]" = "P_Int_Minetti [W]"
                   ),
                   selected = "P_mech [W]"),
      checkboxGroupInput("selectedProband", "Probanden:",
                         choices = sort(unique(Erg_data_short$Proband)),
                         selected = sort(unique(Erg_data_short$Proband)))
    ),
    mainPanel(
      width = 10,
      conditionalPanel(
        condition = "input.viewType == 'means'",
        plotlyOutput("boxplot")
      ),
      DTOutput("ergTable")
    )
  )
)

# Server-Logik
server <- function(input, output, session) {
  
  # Gruppierte Variablen nach Dezimalstellen
  digits_0 <- c("nD_Vorgabe [U·min⁻¹]", 
                "P_mech_Vorgabe [W]", "Nr")
  
  digits_1 <- c("nD [U·min⁻¹]",
                "P_mech [W]",
                "P_Int_Minetti [W]", 
                "P_mech_abs [W]",
                "P_max [W]",
                "P_Int_Kinematik [W]", 
                "P_Int_Modell [W]", 
                "P_Int_Kinematik_Modell [W]",
                "Masse [kg]", 
                "uOS [m]",
                "Torque Efficiency [%]", 
                "Pedal_Smoothness [%]",
                "P_L_percent [%]", 
                "P_R_percent [%]")
  
  digits_2 <- c("P_mech_kg [W·kg⁻¹]", 
                "P_max_kg [W·kg⁻¹]")
  
  digits_3 <- c("lKurbel [m]", 
                "Koerperlaenge [m]", 
                "lBein [m]",
                "lOS [m]", 
                "lUS [m]",
                "uOS [m]",
                "uUS [m]")
  
  
  # Hilfsfunktion für Nachkommastellen
  get_digits_for_column <- function(col_name) {
    if(col_name %in% digits_0) {
      return(0)
    } else if(col_name %in% digits_1) {
      return(1)
    } else if(col_name %in% digits_2) {
      return(2)
    } else if(col_name %in% digits_3) {
      return(3)
    }
    return(1)
  }
  
  # Reaktive gefilterte Daten für Tabelle
  filtered_data <- reactive({
    data <- Erg_data_short
    
    if (length(input$selectedProband) > 0) {
      data <- data %>% filter(Proband %in% input$selectedProband)
    }
    
    if (length(input$selectedBedingung) > 0) {
      data <- data %>% filter(Bedingung %in% input$selectedBedingung)
    }
    
    if (length(input$selectedIntensität) > 0) {
      data <- data %>% filter(Intensität %in% input$selectedIntensität)
    }
    
    if (input$viewType == "means") {
      # Bestimme Gruppierungsvariablen basierend auf Auswahl
      group_vars <- c()
      if (length(input$selectedBedingung) > 0 && length(input$selectedIntensität) == 0) {
        group_vars <- "Bedingung"
      } else if (length(input$selectedBedingung) == 0 && length(input$selectedIntensität) > 0) {
        group_vars <- "Intensität"
      } else if (length(input$selectedBedingung) > 0 && length(input$selectedIntensität) > 0) {
        group_vars <- c("Bedingung", "Intensität")
      }
      
      if (length(group_vars) == 0) {
        grouped_data <- data %>%
          summarise(across(where(is.numeric), 
                           list(mean = ~mean(., na.rm = TRUE),
                                sd = ~sd(., na.rm = TRUE)))) %>%
          mutate(Gruppe = "Gesamt")
        group_vars <- "Gruppe"
      } else {
        grouped_data <- data %>%
          group_by(across(all_of(group_vars))) %>%
          summarise(across(where(is.numeric), 
                           list(mean = ~mean(., na.rm = TRUE),
                                sd = ~sd(., na.rm = TRUE)))) %>%
          ungroup()
      }
      
      result_data <- grouped_data %>%
        select(all_of(group_vars))
      
      numeric_cols <- names(data)[sapply(data, is.numeric)]
      for(col in numeric_cols) {
        mean_col <- paste0(col, "_mean")
        sd_col <- paste0(col, "_sd")
        
        if(mean_col %in% names(grouped_data) && sd_col %in% names(grouped_data)) {
          digits <- get_digits_for_column(col)
          result_data[[col]] <- paste0(
            format(round(grouped_data[[mean_col]], digits), nsmall = digits),
            " ± ",
            format(round(grouped_data[[sd_col]], digits), nsmall = digits)
          )
        }
      }
      
      return(result_data)
    }
    
    return(data)
  })
  
  # Reaktive gefilterte Daten für Plots
  filtered_data_plots <- reactive({
    data <- Erg_data_short %>%
      filter(Proband %in% input$selectedProband)
    
    if (length(input$selectedBedingung) > 0) {
      data <- data %>% filter(Bedingung %in% input$selectedBedingung)
    }
    
    if (length(input$selectedIntensität) > 0) {
      data <- data %>% filter(Intensität %in% input$selectedIntensität)
    }
    
    # Gruppierung basierend auf Auswahl
    if (length(input$selectedBedingung) > 0 && length(input$selectedIntensität) == 0) {
      data$Gruppe <- data$Bedingung
    } else if (length(input$selectedBedingung) == 0 && length(input$selectedIntensität) > 0) {
      data$Gruppe <- data$Intensität
    } else {
      data$Gruppe <- paste(data$Intensität, data$Bedingung, sep = "_")
    }
    
    return(data)
  })
  
  # Color Map
  color_map <- reactive({
    c(
      "leicht_sitzen" = "#42BA97", "leicht_stehen" = "#62A39F",
      "moderat_sitzen" = "#1CADE4", "moderat_stehen" = "#2683C6",
      "schwer_sitzen" = "#EF5350", "schwer_stehen" = "#C8133B"
    )
  })
  
  # Tabellen-Output
  output$ergTable <- renderDT({
    data <- filtered_data()
    
    if (input$viewType == "individual") {
      columnDefs <- lapply(seq_len(ncol(data)), function(i) {
        list(
          targets = i-1,
          width = paste0(max(
            nchar(names(data)[i]),
            max(nchar(as.character(data[[i]])))
          ) * 10, "px"),
          className = "dt-nowrap"
        )
      })
      
      datatable(data,
                options = list(
                  pageLength = 10,
                  scrollX = TRUE,
                  scrollCollapse = TRUE,
                  autoWidth = FALSE,
                  columnDefs = columnDefs
                )
      ) %>%
        formatRound(
          columns = intersect(names(data), digits_0),
          digits = 0
        ) %>%
        formatRound(
          columns = intersect(names(data), digits_1),
          digits = 1
        ) %>%
        formatRound(
          columns = intersect(names(data), digits_2),
          digits = 2
        ) %>%
        formatRound(
          columns = intersect(names(data), digits_3),
          digits = 3
        )
    } else {
      columnDefs <- lapply(seq_len(ncol(data)), function(i) {
        list(
          targets = i-1,
          width = paste0(max(
            nchar(names(data)[i]),
            max(nchar(as.character(data[[i]])))
          ) * 10, "px"),
          className = "dt-nowrap"
        )
      })
      
      datatable(data,
                options = list(
                  pageLength = 10,
                  scrollX = TRUE,
                  scrollCollapse = TRUE,
                  autoWidth = FALSE,
                  columnDefs = columnDefs
                ),
                escape = FALSE
      )
    }
  })
  
  # Boxplot
  output$boxplot <- renderPlotly({
    data <- filtered_data_plots()
    color_map_values <- color_map()
    
    # Farben anpassen basierend auf Gruppierung
    if (length(input$selectedBedingung) > 0 && length(input$selectedIntensität) == 0) {
      colors <- c("sitzen" = "#42BA97", "stehen" = "#62A39F")
    } else if (length(input$selectedBedingung) == 0 && length(input$selectedIntensität) > 0) {
      colors <- c("leicht" = "#42BA97", "moderat" = "#1CADE4", "schwer" = "#EF5350")
    } else {
      colors <- color_map_values
    }
    
    p <- plot_ly(data = data, 
                 x = ~Gruppe, 
                 y = as.formula(paste0("~`", input$selectedVariable, "`")),
                 type = "box",
                 color = ~Gruppe,
                 colors = colors[unique(data$Gruppe)],
                 opacity = 0.8,
                 line = list(color = "black", width = 0.9),
                 boxpoints = "outliers",
                 pointpos = 0,
                 marker = list(color = "black", size = 4),
                 boxmean = TRUE,
                 hoverlabel = list(bgcolor = "#F5F5F5")
    ) %>%
      layout(title = paste('Boxplot:', input$selectedVariable),
             margin = list(t = 40),
             xaxis = list(title = "Gruppe"),
             yaxis = list(title = input$selectedVariable))
    
    return(p)
  })
}

# App starten
shinyApp(ui = ui, server = server)